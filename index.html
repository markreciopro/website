<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyzeo ( ) - Your Partner in Data-Driven Growth</title>
    <!-- Load Tailwind CSS from CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import a monospace font for a "programmed" feel */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Roboto Mono', monospace;
            overflow-x: hidden;
            background-color: #2D2D2D; /* Dark charcoal background */
            color: #F8F8F2; /* Soft white text */
        }
        .container {
            max-width: 800px;
        }
        /* Custom scrollbar for chat windows */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #3C3C3C;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #A6E22E;
            border-radius: 4px;
            border: 2px solid #3C3C3C;
        }
        /* CSS for the loading dots animation */
        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% {
                color: rgba(0,0,0,0);
                text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);
            }
            40% {
                color: #B0B0B0;
                text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);
            }
            60% {
                text-shadow: .25em 0 0 #B0B0B0, .5em 0 0 rgba(0,0,0,0);
            }
            80%, 100% {
                text-shadow: .25em 0 0 #B0B0B0, .5em 0 0 #B0B0B0;
            }
        }
    </style>
</head>
<body class="bg-[#2D2D2D] text-[#F8F8F2]">

    <!-- Main content container, centered and responsive -->
    <div class="container mx-auto p-4 sm:p-6 md:p-8 lg:p-10 relative z-10">

        <!-- Sticky navigation bar at the top -->
        <nav class="sticky top-0 bg-[#3C3C3C] rounded-xl shadow-lg p-4 mb-8 flex justify-center z-50 border border-[#505050]">
            <a href="#about" class="text-gray-400 hover:text-[#A6E22E] font-medium mx-4 transition-colors">About</a>
            <a href="#services" class="text-gray-400 hover:text-[#A6E22E] font-medium mx-4 transition-colors">Services</a>
            <a href="#recommendations" class="text-gray-400 hover:text-[#A6E22E] font-medium mx-4 transition-colors">Recommendations</a>
            <a href="#contact" class="text-gray-400 hover:text-[#A6E22E] font-medium mx-4 transition-colors">Contact</a>
        </nav>

        <!-- Header section -->
        <header class="text-center py-10">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-[#A6E22E] mb-4 tracking-tight">Analyzeo ( )</h1>
            <p class="text-lg sm:text-xl text-gray-400 max-w-2xl mx-auto">
                Transforming businesses with data-driven insights and innovative solutions.
            </p>
        </header>

        <!-- About Us section -->
        <section id="about" class="bg-[#3C3C3C] rounded-xl shadow-lg p-6 sm:p-8 mb-8 border border-[#505050]">
            <h2 class="text-2xl sm:text-3xl font-bold text-[#A6E22E] border-b-2 border-[#66D9EF] pb-2 mb-4">About Us</h2>
            <p class="text-[#F8F8F2] leading-relaxed">
                At Analyzeo ( ), we believe that every business has a unique story hidden in its data. We are a team of passionate
                analysts and technologists dedicated to helping companies uncover these stories and leverage them for
                strategic growth. Our mission is to provide clear, actionable insights that empower our clients to make
                smarter decisions, optimize operations, and achieve their goals.
            </p>
        </section>

        <!-- Services section with a grid layout -->
        <section id="services" class="bg-[#3C3C3C] rounded-xl shadow-lg p-6 sm:p-8 mb-8 border border-[#505050]">
            <h2 class="text-2xl sm:text-3xl font-bold text-[#A6E22E] border-b-2 border-[#66D9EF] pb-2 mb-4">Our Services</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Business Intelligence</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Building custom dashboards and reports to visualize key performance indicators and monitor business health.
                    </p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Data Analytics</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Performing deep-dive analysis to uncover trends, patterns, and opportunities for improvement.
                    </p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Predictive Modeling</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Developing predictive models to forecast future outcomes and support strategic planning.
                    </p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">HR Analytics</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Leveraging workforce data to optimize recruitment, retention, and employee engagement strategies.
                    </p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Business Analytics</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Utilizing data to uncover insights that optimize operations and drive strategic business growth.
                    </p>
                </div>
            </div>
        </section>

        <!-- Testimonials section -->
        <section id="testimonials" class="bg-[#3C3C3C] rounded-xl shadow-lg p-6 sm:p-8 mb-8 border border-[#505050]">
            <h2 class="text-2xl sm:text-3xl font-bold text-[#A6E22E] border-b-2 border-[#66D9EF] pb-2 mb-4">What Our Clients Say</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555]">
                    <p class="text-[#F8F8F2] italic leading-relaxed mb-4">"Analyzeo ( )'s insights completely transformed our marketing strategy. Their team is knowledgeable, responsive, and a pleasure to work with."</p>
                    <p class="text-right font-semibold text-[#A6E22E]">- Jane Davis, CEO of TechCorp</p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555]">
                    <p class="text-[#F8F8F2] italic leading-relaxed mb-4">"The data analysis they provided was exactly what we needed to optimize our operations. We saw a significant increase in efficiency almost immediately."</p>
                    <p class="text-right font-semibold text-[#A6E22E]">- John Chen, Operations Director</p>
                </div>
            </div>
        </section>

        <!-- Expertise section with tech tags -->
        <section id="expertise" class="bg-[#3C3C3C] rounded-xl shadow-lg p-6 sm:p-8 mb-8 border border-[#505050]">
            <h2 class="text-2xl sm:text-3xl font-bold text-[#A6E22E] border-b-2 border-[#66D9EF] pb-2 mb-4">Our Expertise</h2>
            <div class="flex flex-wrap gap-2">
                <span class="bg-[#555555] text-[#D0D0D0] text-sm font-medium px-4 py-2 rounded-full border border-[#666666]">Visual Studio</span>
                <span class="bg-[#555555] text-[#D0D0D0] text-sm font-medium px-4 py-2 rounded-full border border-[#666666]">Python</span>
                <span class="bg-[#555555] text-[#D0D0D0] text-sm font-medium px-4 py-2 rounded-full border border-[#666666]">R</span>
                <span class="bg-[#555555] text-[#D0D0D0] text-sm font-medium px-4 py-2 rounded-full border border-[#666666]">SQL</span>
                <span class="bg-[#555555] text-[#D0D0D0] text-sm font-medium px-4 py-2 rounded-full border border-[#666666]">Power BI</span>
                <span class="bg-[#555555] text-[#D0D0D0] text-sm font-medium px-4 py-2 rounded-full border border-[#666666]">Tableau</span>
                <span class="bg-[#555555] text-[#D0D0D0] text-sm font-medium px-4 py-2 rounded-full border border-[#666666]">Advanced Excel</span>
            </div>
        </section>

        <!-- Recommendations section for data growth -->
        <section id="recommendations" class="bg-[#3C3C3C] rounded-xl shadow-lg p-6 sm:p-8 mb-8 border border-[#505050]">
            <h2 class="text-2xl sm:text-3xl font-bold text-[#A6E22E] border-b-2 border-[#66D9EF] pb-2 mb-4">Our Recommendations for Data Growth</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Start with a Clear Question</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Before you start collecting data, define the specific business question you want to answer. A clear objective ensures your analysis is focused and relevant.
                    </p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Centralize Your Data</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Bring all your data sources into a single, unified location. This eliminates silos and provides a holistic view of your business, making analysis more efficient.
                    </p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Prioritize Data Quality</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Garbage in, garbage out. Invest in data cleansing and validation to ensure the accuracy and reliability of your information. High-quality data leads to trustworthy insights.
                    </p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Don't Be Afraid to Experiment</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Data analysis is an iterative process. Try new models, test different hypotheses, and explore new tools to uncover unexpected and valuable findings.
                    </p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Laser-Focused Goal Setting</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Define precise, measurable goals for your data initiatives. A focused approach ensures that your resources are directed toward achieving specific, high-impact results.
                    </p>
                </div>
                <div class="bg-[#454545] p-6 rounded-lg border border-[#555555] hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-[#66D9EF] mb-2">Embrace Collaborative Insights</h3>
                    <p class="text-[#E0E0E0] text-sm">
                        Data comes alive when different parts "connect." Encourage collaboration across teams to combine diverse data sets and uncover powerful, cross-functional insights.
                    </p>
                </div>
            </div>
        </section>

        <!-- Contact Us section -->
        <section id="contact" class="bg-[#3C3C3C] rounded-xl shadow-lg p-6 sm:p-8 mb-8 border border-[#505050]">
            <h2 class="text-2xl sm:text-3xl font-bold text-[#A6E22E] border-b-2 border-[#66D9EF] pb-2 mb-4">Contact Us</h2>
            <div class="space-y-4">
                <p class="flex items-center text-[#F8F8F2]">
                    <svg class="w-5 h-5 text-[#66D9EF] mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>
                    <a href="mailto:analyzeo@proton.me" class="text-[#66D9EF] hover:underline">analyzeo@proton.me</a>
                </p>
                <p class="flex items-center text-[#F8F8F2]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-[#66D9EF] mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.128a4 4 0 002.557 2.557l1.127-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                    <a href="tel:7027148551" class="text-[#66D9EF] hover:underline">(702) 714-8551</a>
                </p>
                <p class="flex items-center text-[#F8F8F2]">
                    <svg class="w-5 h-5 text-[#66D9EF] mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v2a1 1 0 001 1h10a1 1 0 001-1v-2l-2-2h-3l-2 2H4zm1-4a1 1 0 110-2 1 1 0 010 2z" clip-rule="evenodd"></path></svg>
                    <a href="#" class="text-[#66D9EF] hover:underline">Las Vegas, Nevada 89115</a>
                </p>
            </div>
        </section>

        <!-- Footer section -->
        <footer class="text-center text-sm text-gray-500 mt-8">
            <p>&copy; 2023 Analyzeo ( ). All Rights Reserved.</p>
        </footer>

    </div>

    <!-- Live Chat Widget -->
    <div id="chat-widget" class="fixed bottom-4 right-4 z-50">
        <!-- Chat toggle button -->
        <button id="chat-toggle" class="bg-[#A6E22E] text-white rounded-full p-4 shadow-lg hover:bg-lime-600 focus:outline-none transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
        </button>

        <!-- Chat box container -->
        <div id="chat-box" class="hidden fixed bottom-20 right-4 w-full max-w-lg h-96 bg-[#2D2D2D] rounded-lg shadow-xl flex flex-col transition-transform duration-300 transform scale-95 opacity-0 border border-[#505050] md:flex-row md:h-[600px] md:max-w-4xl">
            <!-- Left Sidebar: Recent Chats and User Info -->
            <div class="flex flex-col w-full md:w-1/3 space-y-4 p-4 bg-[#3C3C3C] rounded-l-lg md:rounded-r-none">
                <h2 class="text-md md:text-lg font-bold text-[#A6E22E]">Your Info</h2>
                <div id="auth-info" class="p-3 bg-[#454545] rounded-xl shadow-inner text-xs md:text-sm">
                    <p class="text-[#F8F8F2]"><strong>Loading...</strong></p>
                </div>
                
                <h2 class="text-md md:text-lg font-bold text-[#A6E22E] mt-6">Recent Chats</h2>
                <div id="recentChatsList" class="flex-grow bg-[#454545] rounded-xl p-2 shadow-inner overflow-y-auto custom-scrollbar">
                    <p class="text-center text-gray-500 p-4 text-sm">No recent chats.</p>
                </div>
                <!-- Self Chat button -->
                <button id="self-chat-btn" class="bg-[#66D9EF] text-[#2D2D2D] p-2 rounded-md hover:bg-sky-600 transition-colors focus:outline-none font-semibold">
                    Start a Self Chat
                </button>
                
                <div id="statusMessage" class="text-xs text-center font-medium p-2 rounded-lg text-red-400 hidden"></div>
            </div>

            <!-- Right Main: Chat Window -->
            <div class="flex flex-col w-full md:w-2/3 space-y-4 p-4 rounded-r-lg bg-[#2D2D2D]">
                <div id="chatHeader" class="text-md md:text-lg font-bold text-[#A6E22E] hidden text-center"></div>
                <div id="typingIndicator" class="text-sm text-gray-500 text-center hidden">...is typing</div>
                <div id="chatWindow" class="flex-1 flex flex-col space-y-3 overflow-y-auto p-2 bg-[#3C3C3C] rounded-lg shadow-inner custom-scrollbar">
                    <div id="chatLoader" class="hidden text-center text-gray-400 p-4">Loading chat...</div>
                    <p class="text-center text-gray-400 p-4">Select a chat from the left to begin.</p>
                </div>

                <!-- Message input form -->
                <form id="message-form" class="flex space-x-2">
                    <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 p-2 bg-[#3C3C3C] text-[#F8F8F2] border border-[#555555] rounded-md text-sm focus:outline-none focus:border-[#A6E22E]">
                    <button type="submit" class="bg-[#A6E22E] text-[#2D2D2D] p-2 rounded-md hover:bg-lime-600 transition-colors focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Custom UI message box to replace alert().
         * @param {string} message - The message to display.
         * @param {string} type - 'info' or 'error' to change color.
         */
        const showMessage = (message, type = 'info') => {
            const container = document.getElementById('chat-widget');
            const messageBox = document.createElement('div');
            messageBox.className = `p-3 rounded-md shadow-md mb-2 text-sm text-white transition-all duration-300 transform translate-y-2 opacity-0
                                    ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            messageBox.textContent = message;
            container.appendChild(messageBox);
            setTimeout(() => {
                messageBox.classList.remove('translate-y-2', 'opacity-0');
                messageBox.classList.add('translate-y-0', 'opacity-100');
            }, 10);
            setTimeout(() => {
                messageBox.classList.remove('translate-y-0', 'opacity-100');
                messageBox.classList.add('translate-y-2', 'opacity-0');
                setTimeout(() => messageBox.remove(), 300);
            }, 3000);
        };
    </script>

    <script type="module">
        // Import necessary Firebase services as modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CHAT FUNCTIONALITY ---
        let db, auth, userId, unsubscribeFromChats, unsubscribeFromMessages;
        let activeChatRecipient = null;
        const messagesContainer = document.getElementById('chatWindow');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const recentChatsList = document.getElementById('recentChatsList');
        const authInfo = document.getElementById('auth-info');
        const chatHeader = document.getElementById('chatHeader');
        const chatToggle = document.getElementById('chat-toggle');
        const chatBox = document.getElementById('chat-box');
        const typingIndicator = document.getElementById('typingIndicator');
        const selfChatBtn = document.getElementById('self-chat-btn');
        const statusMessageDiv = document.getElementById('statusMessage');

        // Event listener to toggle the chat box visibility
        chatToggle.addEventListener('click', () => {
            const isHidden = chatBox.classList.contains('hidden');
            if (isHidden) {
                chatBox.classList.remove('hidden', 'scale-95', 'opacity-0');
                chatBox.classList.add('scale-100', 'opacity-100');
            } else {
                chatBox.classList.remove('scale-100', 'opacity-100');
                chatBox.classList.add('scale-95', 'opacity-0');
                setTimeout(() => chatBox.classList.add('hidden'), 300);
            }
        });

        // Event listener for the new Self Chat button
        selfChatBtn.addEventListener('click', () => {
            if (userId) {
                selectChat(userId);
                statusMessageDiv.classList.add('hidden'); // Hide status message on chat selection
            } else {
                showMessage("Authentication not ready. Please wait.", "error");
            }
        });

        // --- FIREBASE SETUP & AUTHENTICATION ---
        const setupAuthAndFirestore = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                let user;
                if (initialAuthToken) {
                    try {
                        const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        user = userCredential.user;
                        console.log("Signed in with custom token successfully.");
                    } catch (error) {
                        console.error("Custom token sign-in failed. Falling back to anonymous sign-in.", error);
                        const userCredential = await signInAnonymously(auth);
                        user = userCredential.user;
                        console.log("Signed in anonymously successfully.");
                    }
                } else {
                    const userCredential = await signInAnonymously(auth);
                    user = userCredential.user;
                    console.log("Initial auth token not available, signed in anonymously.");
                }

                if (user) {
                    userId = user.uid;
                    authInfo.innerHTML = `
                        <p class="font-bold text-[#A6E22E]">Your User ID:</p>
                        <p class="text-[#F8F8F2] break-all">${userId}</p>
                    `;
                    listenForRecentChats();
                    showMessage("Authenticated successfully!", "success");
                } else {
                    console.error("Failed to authenticate with any method.");
                    showMessage("Authentication failed. Please check the console for details.", "error");
                }
            } catch (e) {
                console.error("Error setting up Firebase services:", e);
                showMessage("An error occurred during app initialization. Check console.", "error");
            }
        };

        // --- FIRESTORE CHAT LOGIC ---

        /**
         * Creates a consistent Firestore path for private chats.
         * The user IDs are sorted alphabetically to ensure the path is the same regardless of who starts the chat.
         * @param {string} user1 - First user ID.
         * @param {string} user2 - Second user ID.
         * @returns {string} The Firestore collection path.
         */
        const getChatId = (user1, user2) => {
            const sortedUsers = [user1, user2].sort();
            return `${sortedUsers[0]}_${sortedUsers[1]}`;
        };

        /**
         * Listens for all chats associated with the current user (the owner).
         */
        const listenForRecentChats = () => {
            const chatsCollectionPath = `artifacts/${appId}/public/data/private_chats`;
            const q = collection(db, chatsCollectionPath);
            
            unsubscribeFromChats = onSnapshot(q, (snapshot) => {
                const allChats = [];
                snapshot.forEach(doc => {
                    const chat = doc.data();
                    // We only want chats where the current user is a participant
                    if (doc.id.includes(userId)) {
                        const parts = doc.id.split('_');
                        const recipientId = (parts[0] === parts[1]) ? parts[0] : parts.find(id => id !== userId);
                        if (recipientId) {
                            allChats.push({ id: doc.id, recipientId, lastMessage: chat.lastMessage, timestamp: chat.timestamp });
                        }
                    }
                });
                
                // Sort chats by last message timestamp
                allChats.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                recentChatsList.innerHTML = '';
                if (allChats.length === 0) {
                    recentChatsList.innerHTML = '<p class="text-center text-gray-500 p-4 text-sm">No recent chats.</p>';
                } else {
                    allChats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.className = `p-3 rounded-lg cursor-pointer hover:bg-[#505050] transition-colors
                                              ${activeChatRecipient === chat.recipientId ? 'bg-[#505050]' : 'bg-[#454545]'}`;
                        const chatName = chat.recipientId === userId ? 'Self Chat' : `Chat with: ${chat.recipientId}`;
                        chatItem.innerHTML = `
                            <p class="text-[#66D9EF] font-semibold text-sm">${chatName}</p>
                            <p class="text-xs break-all text-gray-400 mb-1">${chat.recipientId === userId ? userId : chat.recipientId}</p>
                            <p class="text-xs italic text-gray-500 truncate">${chat.lastMessage || 'No messages yet.'}</p>
                        `;
                        chatItem.addEventListener('click', () => {
                            if (activeChatRecipient !== chat.recipientId) {
                                selectChat(chat.recipientId);
                            }
                        });
                        recentChatsList.appendChild(chatItem);
                    });
                }
            });
        };

        /**
         * Selects a chat and sets up the real-time listener for messages.
         * @param {string} recipientId - The ID of the recipient to chat with.
         */
        const selectChat = async (recipientId) => {
            // Unsubscribe from the previous messages listener if it exists
            if (unsubscribeFromMessages) {
                unsubscribeFromMessages();
            }
            activeChatRecipient = recipientId;
            chatHeader.textContent = recipientId === userId ? 'Self Chat' : `Chatting with: ${recipientId}`;
            chatHeader.classList.remove('hidden');
            messagesContainer.innerHTML = '';
            
            // Highlight the active chat in the list
            const chatItems = recentChatsList.querySelectorAll('div');
            chatItems.forEach(item => {
                item.classList.remove('bg-[#505050]');
                if (item.querySelector('p:nth-child(2)').textContent.includes(recipientId)) {
                    item.classList.add('bg-[#505050]');
                }
            });

            const chatId = getChatId(userId, recipientId);
            const messagesCollectionPath = `artifacts/${appId}/public/data/private_chats/${chatId}/messages`;
            
            // Ensure the parent chat document exists to prevent permission errors
            try {
                const chatDocRef = doc(db, `artifacts/${appId}/public/data/private_chats`, chatId);
                const chatDoc = await getDoc(chatDocRef);
                if (!chatDoc.exists()) {
                    await setDoc(chatDocRef, {
                        user1: userId,
                        user2: recipientId,
                        lastMessage: 'Chat started.',
                        timestamp: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Error creating chat document:", e);
                showMessage("Could not initialize chat. Check console for details.", "error");
                return;
            }

            const q = query(collection(db, messagesCollectionPath), orderBy("timestamp"));
            
            messagesContainer.innerHTML = '<p id="chatLoader" class="text-center text-gray-400 p-4">Loading chat...</p>';

            // Set up the new real-time listener for the chat
            unsubscribeFromMessages = onSnapshot(q, (snapshot) => {
                document.getElementById('chatLoader')?.classList.add('hidden');
                messagesContainer.innerHTML = ''; // Clear old messages
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    displayMessage(message);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        };

        /**
         * Appends a new message to the chat display.
         * @param {object} message - The message data from Firestore.
         */
        const displayMessage = (message) => {
            const messageElement = document.createElement('div');
            const isSentByMe = message.senderId === userId;
            messageElement.className = `flex ${isSentByMe ? 'justify-end' : 'justify-start'}`;
            messageElement.innerHTML = `
                <div class="max-w-[75%] p-3 rounded-xl shadow-md break-words
                            ${isSentByMe ? 'bg-[#A6E22E] text-[#2D2D2D] rounded-br-none' : 'bg-[#454545] text-[#F8F8F2] rounded-bl-none'}">
                    <p class="font-bold text-xs mb-1 ${isSentByMe ? 'hidden' : ''}">User ID: ${message.senderId}</p>
                    <p>${message.text}</p>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
        };

        // Event listener for sending a new message
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (!activeChatRecipient) {
                statusMessageDiv.textContent = "Please select a chat to send a message.";
                statusMessageDiv.classList.remove('hidden');
                return;
            }
            statusMessageDiv.classList.add('hidden');

            if (text && userId && activeChatRecipient) {
                const chatId = getChatId(userId, activeChatRecipient);
                const messagesCollectionPath = `artifacts/${appId}/public/data/private_chats/${chatId}/messages`;
                
                try {
                    // Update the main chat document with the last message
                    const chatDocRef = doc(db, `artifacts/${appId}/public/data/private_chats`, chatId);
                    await setDoc(chatDocRef, {
                        lastMessage: text,
                        timestamp: serverTimestamp()
                    }, { merge: true });
                    
                    // Add a new message document to the messages sub-collection
                    await addDoc(collection(db, messagesCollectionPath), {
                        text,
                        senderId: userId,
                        timestamp: serverTimestamp(), // Use server timestamp for accurate ordering
                    });
                    
                    messageInput.value = ''; // Clear the input field
                } catch (e) {
                    console.error("Error sending message: ", e);
                    showMessage("Error sending message. Please try again.", "error");
                }
            } else if (!activeChatRecipient) {
                showMessage("Please select a chat to send a message.", "error");
            }
        });

        // Initialize Firebase services on page load
        setupAuthAndFirestore();
    </script>
</body>
</html>